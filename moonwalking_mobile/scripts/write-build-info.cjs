#!/usr/bin/env node
/**
 * Writes a small TypeScript snippet exporting build metadata for the worker.
 * Injects commit SHA (if git present), timestamp, and package version.
 */
const { execSync } = require('node:child_process')
const { readFileSync, writeFileSync } = require('node:fs')
const { join } = require('node:path')

function getCommit() {
  try { return execSync('git rev-parse --short HEAD').toString().trim() } catch { return 'unknown' }
}
function getVersion() {
  try {
    const pkg = JSON.parse(readFileSync(join(__dirname,'../backend-workers/moonwalking-worker/package.json'),'utf8'))
    return pkg.version || '0.0.0'
  } catch { return '0.0.0' }
}
const meta = {
  version: getVersion(),
  commit: process.env.COMMIT_SHA || getCommit(),
  built_at: new Date().toISOString()
}
const out = `// AUTO-GENERATED BY build:info\n(globalThis as any).__MW_BUILD__ = ${JSON.stringify(meta, null, 2)};\n`
writeFileSync(join(__dirname,'../backend-workers/moonwalking-worker/src/build-info.generated.ts'), out)
console.log('Wrote build-info.generated.ts with', meta)
